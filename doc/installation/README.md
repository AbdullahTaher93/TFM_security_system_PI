# Backend installation guide

In this section it is going to make a guide on the necessary steps to carry out a correct installation of services and 
dependencies for the backend application.

---

## Required installation

The following components will then be installed:

- RabbitMQ server
- SQLite3
- Python3 dependencies
- Streaming server dependencies

### RabbitMQ server

RabbitMQ is an open source message broker. It is necessary to be able to manage the queues of the asynchronous tasks of the application.

It can be easily installed using the following command:

```Bash
sudo apt-get install rabbitmq-server
```

By default, RabbitMQ will listen on port 5672 on all available interfaces. You can check if the service is available with:

```Bash
sudo service rabbitmq-server status
```

### SQLite3

To store the states of asynchronous tasks, it is necessary to specify a storage backend. In this case, SQLite has been 
selected as it is very light and easy to use and configure.

You can easily install this service, using the command:

```Bash
sudo apt-get install sqlite3
```
Once it has been installed, check that you can access the sqlite terminal with the command:

```Bash
sqlite3
```

### Python dependencies

To install python dependencies, it is recommended that a virtual environment be created. 
You can create one quickly using the command:

```Bash
python3 -m venv ./venv
```

You can then activate that environment using:

```Bash
source venv/bin/activate
```
You can then install all the required dependencies using the following command:

```Bash
pip3 install -r minium_requirements.txt
```

### Streaming server dependencies

For real time transmission of the video, it is necessary to install the following codec and python package for websocket.

```Bash
sudo apt-get install ffmpeg python3-ws4py
```
---

## Full installation

> **Note:** Before starting this installation, it is necessary to have carried out the required installation described in the previous section.

The complete installation includes the image processing for the detection of objects used by the 
[object detector agent](https://github.com/jmv74211/TFM_security_system_PI/blob/master/backend_app/src/agents/object_detector_agent.py), 
whose functionality is to filter the alerts generated by the motion agent, alerting only in the case of detecting a person 
in the image captured during the alert.

This installation is optional, since you can disable this functionality by setting the False value to `DETECTOR_AGENT_STATUS` in 
the [settings.py](https://github.com/jmv74211/TFM_security_system_PI/blob/master/backend_app/src/settings.py) configuration file.

The following components will be installed:

- TensorFlow
- OpenCV
- Protobuf
- Python3 dependencies

> **Note:** Most of the following information has been obtained at this [link](https://github.com/EdjeElectronics/TensorFlow-Object-Detection-on-the-Raspberry-Pi)

### Tensorflow

Tensorflow is the framework that will be used for object recognition in images. For its installation, we can use the 
following command:

```Bash
pip3 install tensorflow==1.14.0
```
Or install the dependencies included in the `full_requirements.txt` file, where it will be installed
tensorflow packages for python3.   

```Bash
pip3 install -r full_requirements.txt
```

> **Warning:** It is possible that if all libraries are installed from the full_requirements file, a memory failure may occur, 
due to the fact that these libraries are very heavy and are stored in the cache when they are downloaded (before being installed). 
If this error occurs, simply install the tensorflow package manually, as stated at the beginning.

Next, it is necessary to execute the following commands to install some dependencies necessary for tensorflow.


```Bash
sudo apt-get install libatlas-base-dev
sudo pip3 install pillow lxml matplotlib cython
sudo apt-get install python-tk
```

### OpenCV

TensorFlow’s object detection examples typically use matplotlib to display images, but I prefer to use OpenCV because it’s easier to work with and less error prone. The object detection scripts in this guide’s GitHub repository use OpenCV. So, we need to install OpenCV.

To get OpenCV working on the Raspberry Pi, there’s quite a few dependencies that need to be installed through apt-get. If any of the following commands don’t work, issue “sudo apt-get update” and then try again. Issue:

```bash
sudo apt-get install libjpeg-dev libtiff5-dev libjasper-dev libpng12-dev
sudo apt-get install libavcodec-dev libavformat-dev libswscale-dev libv4l-dev
sudo apt-get install libxvidcore-dev libx264-dev
sudo apt-get install qt4-dev-tools
```

Now that we have got all those installed, we can install OpenCV, using:

```bash
pip3 install opencv-python
```

or

```bash
pip3 install -r full_requirements.txt
```
### Compile and Install Protobuf

Okay, here comes the hard part.The TensorFlow object detection API uses Protobuf, a package that implements Google’s 
Protocol Buffer data format. Unfortunately, there’s currently no easy way to install Protobuf on the Raspberry Pi. 
We have to compile it from source ourselves and then install it.

First, get the packages needed to compile Protobuf from source. Issue:

```bash
sudo apt-get install autoconf automake libtool curl
```

Then download the protobuf release from its GitHub repository by issuing:

```bash
wget https://github.com/protocolbuffers/protobuf/releases/download/v3.9.0/protobuf-all-3.9.0.tar.gz
```

If a more recent version of protobuf is available, download that instead. Unpack the file and cd into the folder:

```bash
tar -zxvf protobuf-all-3.9.0.tar.gz
cd protobuf-3.9.0
```

Configure the build by issuing the following command (it takes about 2 minutes):

```bash
./configure
```

Build the package by issuing:
```bash
make
```

The build process took 61 minutes on my Raspberry Pi. When it’s finished, issue:

```bash
make check 
```

This process takes even longer, clocking in at 107 minutes on my Pi. According to other guides I’ve seen, this command 
may exit out with errors, but Protobuf will still work. If you see errors, you can ignore them for now. Now that it’s 
built, install it by issuing:

```bash
sudo make install
```

Then move into the python directory and export the library path:

```bash
cd python
export LD_LIBRARY_PATH=../src/.libs
```

Next, issue:

```bash
python3 setup.py build --cpp_implementation 
python3 setup.py test --cpp_implementation
sudo python3 setup.py install --cpp_implementation
```

Then issue the following path commands:

```bash
export PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=cpp
export PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION_VERSION=3
```

Finally, issue:

```bash
sudo ldconfig
```

That’s it! Now Protobuf is installed on the Pi. Verify it’s installed correctly by issuing the command below and making 
sure it puts out the default help text.

```bash
protoc
```

For some reason, the Raspberry Pi needs to be restarted after this process, or TensorFlow will not work. 
Go ahead and reboot the Pi by issuing:

```bash
sudo reboot now
```

> **Attention:** In the protos directory inside the [object detector module](https://github.com/jmv74211/TFM_security_system_PI/tree/master/backend_app/src/modules/object_detector)
 the .py files generated from the .proto files have
 been included. If it is necessary to generate them again, it can be done following section 5 of 
 [this reference](https://github.com/EdjeElectronics/TensorFlow-Object-Detection-on-the-Raspberry-Pi).

Once this step has been completed, the installation has been completed.